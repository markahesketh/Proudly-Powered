#!/usr/bin/env ruby

BYPASS_FILES = %w(404.html crossdomain.xml humans.txt robots.txt googlebd82924855df6b5d.html) unless defined?(BYPASS_FILES)

# PREPROCESS
################################################################################

preprocess do
    # Unpublish items by setting meta attribute publish: false
    items.delete_if { |item| item[:publish] == false }

    # Create autogenerated pages
    create_category_pages

    create_sitemap
end


# COMPILE
################################################################################

# Don't compile bypass files
BYPASS_FILES.each do |file|
    compile("/#{file.sub( /\..+/, '')}/") do
    end
end

# Minify assets
compile '/-/*' do
    if item.binary?
        # Don’t filter binary items
    else
    end
end

# Articles Categories
compile '/category/*/' do
    filter :erb
    layout 'category'
end

# General compile
compile '*' do
    if item.binary?
        # Don’t filter binary items
    else
        filter :erb
        filter :kramdown if item[:extension] == "md"

        # Set layouts
        case item[:extension]
        when 'xml'
            # Don't give a layout to these extensions
        else
            case item.identifier
            when "/"
                layout 'home'
            else
                layout 'single'
            end
        end
    end
end

# ROUTES
################################################################################
# Don't alter routes of bypass files
BYPASS_FILES.each do |file|
    route("/#{file.sub(/\..+/, '')}/") do
        "/#{file}" # route bypass files as is
    end
end

# Articles - Remove /articles/ from route
route '/articles/*/' do
    "/" + item.identifier.sub(/^\/articles\//,'') + "index.html"
end

# Pagination
route '*/page/*' do
  section,subsection,page_title,page_number = /([^\/]+)\/([^\/]+)\/([^\/]+)\/([0-9]+)/.match(item.identifier).captures

  if page_number == "1"
    "/#{section}/#{subsection}/index.html"
  else
    "/#{section}/#{subsection}/#{page_number}/index.html"
  end
end

# General Routes
route '*' do
    if item.binary?
        # Write item with identifier /foo/ to /foo.ext
        item.identifier.chop + '.' + item[:extension]
    else
        case item[:extension]
        when 'js', 'css', 'xml'
            item.identifier.chop + '.' + item[:extension]
        else
                # Write item with identifier /foo/ to /foo/index.html
                item.identifier + 'index.html'
        end
    end
end

layout '*', :erb
